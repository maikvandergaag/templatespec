name: 04-bicepmoduletemplatespec
 
# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    paths:
      - '04-bicepmoduletemplatespec'
    branches: [ main ]
  pull_request:
    branches: [ main ]
 
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
 
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
 
    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/checkout@v2
      - run: | 
          curl -Lo bicepinstall https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x ./bicepinstall
          sudo mv ./bicepinstall /usr/local/bin/bicep
          bicep --help
      - run:    bicep build ./04-bicepmoduletemplatespec/04-bicepmoduletemplatespec.bicep   
      - name: Archive production artifacts
        uses: actions/upload-artifact@v2
        with:
          name: dist-without-markdown
          path: ./**/*.json
  # This workflow contains a single job called "build"
  deploy:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
       - uses: actions/download-artifact@v2
         with:
             name: dist-without-markdown
       - name: directory
         run: ls -R
       - name: Azure Login
         uses: Azure/login@v1
         with:
           # Paste output of `az ad sp create-for-rbac` as value of secret variable: AZURE_CREDENTIALS
           creds: ${{ secrets.AZURE_CREDENTIALS_SPONSORSHIP }}
       - name: Azure CLI Action
         uses: Azure/cli@1.0.4
         with:
           # Specify the script here
           inlineScript: az ts create --name az-tempspec-bicepmodulestorage-github --version "1.0" --resource-group sponsor-rg-templatespecs --location "westeurope" --template-file "./04-bicepmoduletemplatespec/04-bicepmoduletemplatespec.json"

 
